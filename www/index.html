<!DOCTYPE html>
<html>
    <head>
        <title>Sidebar Demo</title>
        <link rel="stylesheet" type="text/css" href="bootstrap/css/bootstrap.css">
        <style type="text/css">
            body {
                font-family: "Lato", sans-serif;
                transition: background-color .5s;
                background-color: #5da58a;/*#ff8080;*/
                overflow: hidden;
            }

            .sidenav {
                height: 100%;
                width: 0;
                position: fixed;
                z-index: 1;
                top: 50px;
                left: 0;
                background-color: #343434;
                overflow-x: hidden;
                transition: 0.5s;
                padding-top: 0px;
            }

            .sidenav a {
                padding: 8px 8px 8px 32px;
                text-decoration: none;
                font-size: 20px;
                color: #B0B0B0;
                display: block;
                transition: 0.3s;
                border: 1px solid #343434;
            }

            .sidenav a:hover, .offcanvas a:focus{
                color: #e7e7e7;
                /*border-top: 1px solid #464646;*/
                border-bottom: 1px solid #464646;
            }

            .sidenav .closebtn {
                position: absolute;
                top: 0;
                right: 25px;
                font-size: 36px;
                margin-left: 50px;
            }

            #main {
                transition: margin-left .5s;
                padding-top: 0px;
                padding-left: 15px;
                overflow: hidden;
            }

            @media screen and (max-height: 450px) {
                .sidenav {padding-top: 15px;}
                .sidenav a {font-size: 18px;}
            }
        </style>
    </head>
<body>
    <div id="mySidenav" class="sidenav">
        <a href="#">Live Tracking</a>
        <a href="#">Speed Analysis</a>
        <a href="#">Distance</a>
        <a href="#">Routes</a>
    </div>

    <div id="main" style="text">
        <span id="btnOpen" style="font-size:30px;cursor:pointer; width: 50px; color:white" onclick="openNav()">&#9776;</span>
        <span id="btnClose" class="closebtn" style="font-size:30px;cursor:pointer; width: 200px; color:white; display: none;" onclick="closeNav()">&times;</span>
        <span class="text-center" style="color:white; font-size: 25px; padding-left: 5px;">Vehicle Tracking</span>
        <div id="googleMap" style="width:100%; height:100%; position: absolute; top: 50px; left: 0px; overflow: hidden;"></div>
    </div>
</body>
</html>
<script type="text/javascript" src="js/jquery1.11.1-min.js"></script>
<script type="text/javascript" src="js/semantic.js"></script>
<script type="text/javascript" src="https://www.gstatic.com/firebasejs/3.6.2/firebase.js"></script>
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?v=3.exp&key=AIzaSyAvCB0fJALK-4VaEiubgiVYuh-pJxNGvH0&callback=LoadMap&libraries=geometry" async defer></script>
<script type="text/javascript">
    var config = {
      apiKey: "AIzaSyA-qB_P4ILz6FHSEVLydbd4_R8jXGBWthM",
      authDomain: "api-project-234444986540.firebaseapp.com",
      databaseURL: "https://api-project-234444986540.firebaseio.com/"
    };

    firebase.initializeApp(config);

    var rootRef = firebase.database().ref();
    var coords = [], colors = ["#38c6f3", "#4a5ba9", "#ff4864", "#166048", "#291f09", "#800000", "#0000ff", "#ff0000", "#512411", "#e3af0c"];
    var gstartmarkers = [], gendmarkers = [], gtourplans = [];
    var map, infowindow;

    function openNav() {
        document.getElementById("mySidenav").style.width = "200px";
        //document.getElementById("main").style.marginLeft = "250px";
        //document.body.style.backgroundColor = "rgba(0,0,0,0.4)";
        document.getElementById("btnOpen").style.display = "none";
        document.getElementById("btnClose").style.display = "inline";
    }

    function closeNav() {
        document.getElementById("mySidenav").style.width = "0";
        document.getElementById("main").style.marginLeft= "0";
        //document.body.style.backgroundColor = "white";
        document.getElementById("btnClose").style.display = "none";
        document.getElementById("btnOpen").style.display = "inline";
    }
    function LoadMap() {
        var mapProp = {
            center: new google.maps.LatLng(14.2599286, 80.1137635),
            zoom: 17,
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            panControl: false,
            zoomControl: false,
            scaleControl: false,
            mapTypeControl: false,
            streetViewControl: false,
            overviewMapControl: false,
            rotateControl: false
        };

        map = new google.maps.Map(document.getElementById("googleMap"), mapProp);
        infowindow = new google.maps.InfoWindow();
        var marker1 = new google.maps.Marker({
            position: new google.maps.LatLng(14.2599286, 80.1137635),
            icon: "img/icon.png",
            draggable: false,
            map: map
        });

        map.addListener('click', function(){
            infowindow.close();
        });

        rootRef.on('value', function(snapshot){
            if(snapshot.exists()){
                var colorNo = 0;
                removeMarkers();

                snapshot.forEach(function(data) {
                    var i = Object.values(data.val()).length, k = 0;
                    coords = [];
                    if(i > 0){
                        for(var j = 0; j < i; j++){
                            try {
                                k = k + 1;
                                coords.push(new google.maps.LatLng(data.val()[j].latlng.split(',')[0], data.val()[j].latlng.split(',')[1]));
                            }
                            catch(e){
                                coords = [];
                                continue;
                            }
                        }
                        var color = colors[colorNo];
                        if(colorNo == 9){
                            colorNo = 0;
                        }
                        else{
                            colorNo = parseInt(colorNo) + 1;
                        }

                        var startMarker = new google.maps.Marker({
                            position: coords[0],
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 5,
                                strokeWeight: 3,
                                strokeColor: color,//"#bc2c30",
                                //strokeOpacity: 0.8,
                                fillColor: color,
                                fillOpacity: 1
                            },
                            draggable: false,
                            map: map
                        });
                        //map.setCenter(startMarker.getPosition());
                        gstartmarkers.push(startMarker);

                        google.maps.event.addListener(startMarker, 'click', function(){
                            infowindow.close();
                            OpenInfo(data.key, startMarker.getPosition(), startMarker.getPosition());
                        });

                        var car = "M17.402,0H5.643C2.526,0,0,3.467,0,6.584v34.804c0,3.116,2.526,5.644,5.643,5.644h11.759c3.116,0,5.644-2.527,5.644-5.644 V6.584C23.044,3.467,20.518,0,17.402,0z M22.057,14.188v11.665l-2.729,0.351v-4.806L22.057,14.188z M20.625,10.773 c-1.016,3.9-2.219,8.51-2.219,8.51H4.638l-2.222-8.51C2.417,10.773,11.3,7.755,20.625,10.773z M3.748,21.713v4.492l-2.73-0.349 V14.502L3.748,21.713z M1.018,37.938V27.579l2.73,0.343v8.196L1.018,37.938z M2.575,40.882l2.218-3.336h13.771l2.219,3.336H2.575z M19.328,35.805v-7.872l2.729-0.355v10.048L19.328,35.805z";

                        if(coords.length > 1) {
                            var heading = google.maps.geometry.spherical.computeHeading(coords[coords.length - 2], coords[coords.length - 1]);
                            var endMarker = new google.maps.Marker({
                                position: coords[coords.length - 1],
                                icon: {
                                    path: car,
                                    scaledSize: new google.maps.Size(20, 20), // size
                                    origin: new google.maps.Point(0, 0), // origin
                                    anchor: new google.maps.Point(10, 25), // anchor
                                    rotation: heading,
                                    fillColor: color,
                                    fillOpacity: 1,
                                    scale: .8,
                                    strokeColor: "#606060",
                                    strokeOpacity: .7
                                },
                                draggable: false,
                                map: map
                            });
                            //map.setCenter(endMarker.getPosition());
                            gendmarkers.push(endMarker);

                            google.maps.event.addListener(endMarker, 'click', function() {
                                infowindow.close();
                                OpenInfo(data.key, startMarker.getPosition(), endMarker.getPosition());
                            });
                        }

                        var tourplan = new google.maps.Polyline({
                            path: coords,
                            strokeColor: color,
                            //strokeOpacity: 0.6,
                            strokeWeight: 5
                        });
                        tourplan.setMap(map);
                        gtourplans.push(tourplan);

                        google.maps.event.addListener(tourplan, 'click', function(event){
                            infowindow.close();
                            OpenInfo(data.key, startMarker.getPosition(), event.latLng);
                        });
                    }
                 });
            }
        });
    }

    function removeMarkers() {
        for(i = 0; i < gstartmarkers.length; i++) {
            if (gstartmarkers.length > 0 && gstartmarkers[i].getMap() != null) {
                gstartmarkers[i].setMap(null);
            }
        }
        for(i = 0; i < gendmarkers.length; i++) {
            if (gendmarkers.length > 0 && gendmarkers[i].getMap() != null) {
                gendmarkers[i].setMap(null);
            }
        }
        for(i = 0; i < gtourplans.length; i++) {
            if (gtourplans.length > 0 && gtourplans[i].getMap() != null) {
                gtourplans[i].setMap(null);
            }
        }
    }

    function OpenInfo(key, start, end) {
        var msg = "<u><b>Device Id:</b> " + key + "</u><br><br>";

        var origin1 = start;
        var destinationA = end;
        var service = new google.maps.DistanceMatrixService();
        service.getDistanceMatrix({
            origins: [origin1],
            destinations: [destinationA],
            travelMode: 'DRIVING',
            //transitOptions: TransitOptions,
            //drivingOptions: DrivingOptions,
            unitSystem: google.maps.UnitSystem.METRIC,
            avoidHighways: false,
            avoidTolls: false,
        }, function(response, status){
            if (status == 'OK') {
                msg = msg + "<table width='100%'><tr><td align='left' valign='top' style='width: 20%'>Start Position</td><td align='left' valign='top' style='width: 10%'>:</td><td align='left' valign='top' style='width: 70%'>" + response.originAddresses[0] + "</td></tr>";
                msg = msg + "<tr><td align='left' valign='top' style='width: 20%'>End Position</td><td align='left' valign='top' style='width: 10%'>:</td><td align='left' valign='top' style='width: 70%'>" + response.destinationAddresses[0] + "</td></tr>";
                msg = msg + "<tr><td align='left' valign='top' style='width: 20%'>Distance</td><td align='left' valign='top' style='width: 10%'>:</td><td align='left' valign='top' style='width: 70%'>" + response.rows[0].elements[0].distance.text + "</td></tr>";
                msg = msg + "<tr><td align='left' valign='top' style='width: 20%'>Duration</td><td align='left' valign='top' style='width: 10%'>:</td><td align='left' valign='top' style='width: 70%'>" + response.rows[0].elements[0].duration.text + "</td></tr>";
                msg = msg + "</table>";

                infowindow = new google.maps.InfoWindow({
                    content: msg,
                    position: end,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 5,
                        strokeWeight: 2,
                        strokeColor: "#FF00FF",
                        strokeOpacity: 0.8,

                        fillColor: "#FF00FF",
                        fillOpacity: 0.4
                    }
                });
                infowindow.open(map);
            }
        });
    }
</script>

<!--rootRef.child("355666056403785").on('child_removed', function(){
            $("#tbldata").empty();
            rootRef.once("value", function(snapshot) {
                if(snapshot.exists()){
                    $(".message").hide();

                    snapshot.forEach(function(data){
                        $("#tbldata").append("<tr><td colspan='3'><p class='text-danger'>"+ data.key +"</p></td></tr>");
                        var i = data.val().length, k = 0;

                        if(i > 0){
                            for(var j = 0; j < i; j++){
                                if(j == 0)
                                    $("#tbldata").append("<tr><table class='table table-hover table-bordered'><tr><th>Slno</th><th>Location</th><th>Time</th></tr></tr>");
                                if(j == i)
                                    $("#tbldata").append("</table></tr>");
                                k = k + 1;
                                $("#tbldata").append("<tr><td>" + k + "</td><td>" + data.val()[j].latlng + "</td><td>" + data.val()[j].time + "</td></tr>");
                            }
                        }
                     });
                }
                else{
                    $(".message").show();
                    $("#msg").html("No database found. Please check.");
                }
            });
        });*/
        /*var fetchPosts = function(postsRef) {
            postsRef.on('child_added', function(data) {
                debugger;
            });
            postsRef.on('child_changed', function(data) {
                debugger;
            });
            postsRef.on('child_removed', function(data) {
                debugger;
            });
        };*/
        //fetchPosts(rootRef);-->

<!--rootRef.once("value", function(snapshot) {
            var endMarker = new google.maps.Marker();
            if(snapshot.exists()){
                $(".message").hide();
                $("#tbldata").empty();

                snapshot.forEach(function(data){
                    //debugger;
                    //$("#tbldata").append("<tr><td colspan='3'><p class='text-danger'>" + data.key + "</p></td></tr>");
                    var i = data.val().length, k = 0;
                    coords = [];
                    if(i > 0){

                        for(var j = 0; j < i; j++){

                            try {
                                k = k + 1;
                                //$("#tbldata").append("<tr><td>" + k + "</td><td>" + data.val()[j].latlng + "</td><td>" + data.val()[j].time + "</td></tr>");
                                coords.push(new google.maps.LatLng(data.val()[j].latlng.split(',')[0], data.val()[j].latlng.split(',')[1]));
                            }
                            catch(e){
                                coords = [];
                                continue;
                            }
                        }
                        var color = colors[0];

                        var tourplan2 = new google.maps.Polyline({
                            path: coords,
                            strokeColor: color,
                            //strokeOpacity: 0.6,
                            strokeWeight: 2
                        });

                        var startMarker = new google.maps.Marker({
                            position: coords[0],

                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 5,
                                strokeWeight: 2,
                                strokeColor: "#bc2c30",
                                strokeOpacity: 0.8,

                                fillColor: "#ed4b4f",
                                fillOpacity: 0.8
                            },

                            draggable: false,
                            map: map
                        });

                        endMarker.setMap(null);
                        endMarker = new google.maps.Marker({
                            position: coords[coords.length - 1],

                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 5,
                                strokeWeight: 2,
                                strokeColor: "#35835e",
                                strokeOpacity: 0.8,

                                fillColor: "#63a79b",
                                fillOpacity: 0.8
                            },

                            draggable: false,
                            map: map
                        });

                        tourplan2.setMap(map);
                    }
                 });
                }
                else{
                    $("#tbldata").empty();
                    $(".message").show();
                    $("#msg").html("No database found. Please check.");
                    LoadMap();
                }
        });-->
